<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Order System - Waiter Dashboard</title>
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* Institution Header */
        .institution-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
            color: white;
            padding: 1rem 2rem;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .institution-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .institution-tagline {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Waiter Landing */
        .waiter-landing {
            background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .waiter-login {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            color: white;
            text-align: center;
        }

        .waiter-login h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .waiter-login p {
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .waiter-container {
            display: none;
            min-height: 100vh;
        }

        .waiter-container.active {
            display: block;
        }

        .waiter-header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 80px;
        }

        .waiter-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab-btn.active {
            background: var(--primary-color, #2196F3);
            color: white;
        }

        .waiter-tab {
            display: none;
        }

        .waiter-tab.active {
            display: block;
        }

        .waiter-main {
            padding: 2rem;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--accent-color, #4CAF50);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover, #45a049);
            transform: translateY(-2px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }

        .orders-grid,
        .requests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .waiter-order-card,
        .waiter-request-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--primary-color, #2196F3);
            position: relative;
        }

        .waiter-order-card.locked {
            border-left-color: #ff9800;
            background: #fff8e1;
        }

        .waiter-order-card.locked::before {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ff9800;
            font-size: 1.2rem;
        }

        .waiter-order-card:hover,
        .waiter-request-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .waiter-order-card.pending {
            border-left-color: #ff9800;
        }

        .waiter-order-card.preparing {
            border-left-color: var(--primary-color, #2196F3);
        }

        .waiter-order-card.ready {
            border-left-color: var(--accent-color, #4CAF50);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .order-status-badge {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .order-status-badge.pending {
            background: rgba(255, 152, 0, 0.1);
            color: #ff9800;
        }

        .order-status-badge.preparing {
            background: rgba(33, 150, 243, 0.1);
            color: var(--primary-color, #2196F3);
        }

        .order-status-badge.ready {
            background: rgba(76, 175, 80, 0.1);
            color: var(--accent-color, #4CAF50);
        }

        .waiter-badge {
            background: #e3f2fd;
            color: var(--primary-color, #2196F3);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 0.5rem;
        }

        .order-items-preview {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .order-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .order-total {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .wide-modal {
            max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #333;
            font-size: 1.8rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-modal:hover {
            background: #f0f0f0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color, #2196F3);
        }

        .waiter-response-form {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #eee;
        }

        .waiter-id-input {
            font-size: 2rem;
            text-align: center;
            letter-spacing: 5px;
            font-weight: bold;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-color, #4CAF50);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s;
        }

        .notification.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .institution-name {
                font-size: 1.5rem;
            }
            
            .institution-tagline {
                font-size: 0.9rem;
            }
            
            .waiter-tabs {
                flex-direction: column;
            }
            
            .orders-grid,
            .requests-grid {
                grid-template-columns: 1fr;
            }
            
            .tables-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .waiter-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .institution-header {
                padding: 0.5rem 1rem;
            }
            
            .institution-name {
                font-size: 1.2rem;
            }
            
            .institution-tagline {
                font-size: 0.8rem;
            }
            
            .waiter-login {
                padding: 2rem;
            }
            
            .waiter-login h1 {
                font-size: 2rem;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .waiter-header {
                padding: 1rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Institution Header -->
    <div class="institution-header" id="institutionHeader">
        <div class="institution-name" id="institutionName">QR Order System</div>
        <div class="institution-tagline" id="institutionTagline">Waiter Dashboard</div>
    </div>

    <!-- Waiter Landing -->
    <div id="waiterLanding" class="waiter-landing">
        <div class="waiter-login">
            <h1><i class="fas fa-concierge-bell"></i> Waiter Login</h1>
            <p>Enter your 4-digit ID to access dashboard</p>
            <div class="form-group">
                <input type="password" id="waiterId" class="waiter-id-input" placeholder="****" maxlength="4" pattern="\d*" inputmode="numeric">
            </div>
            <button class="btn btn-primary" onclick="loginAsWaiter()" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        </div>
    </div>

    <!-- Waiter Interface -->
    <div id="waiterPage" class="waiter-container">
        <header class="waiter-header">
            <div class="header-left">
                <h1><i class="fas fa-concierge-bell"></i> Waiter Dashboard</h1>
                <div class="waiter-info">
                    <span id="currentWaiterName">Waiter</span>
                    <span id="currentWaiterId"></span>
                    <span class="order-status-badge active">Online</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="showNotificationPanel()">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount">0</span>
                </button>
                <button class="btn" onclick="logoutWaiter()" style="background: #666; color: white;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <main class="waiter-main">
            <nav class="waiter-tabs">
                <button class="tab-btn active" onclick="showWaiterTab('orders')">
                    <i class="fas fa-clipboard-list"></i> Orders
                </button>
                <button class="tab-btn" onclick="showWaiterTab('requests')">
                    <i class="fas fa-bell"></i> Requests
                </button>
                <button class="tab-btn" onclick="showWaiterTab('tables')">
                    <i class="fas fa-chair"></i> Tables
                </button>
                <button class="tab-btn" onclick="showWaiterTab('myOrders')">
                    <i class="fas fa-user-check"></i> My Orders
                </button>
            </nav>

            <section id="ordersTab" class="waiter-tab active">
                <div class="section-header">
                    <h2>Available Orders</h2>
                    <select id="orderFilter" onchange="filterOrders()">
                        <option value="all">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="preparing">Preparing</option>
                        <option value="ready">Ready</option>
                    </select>
                </div>
                <div class="orders-grid" id="waiterOrdersGrid">
                    <!-- Orders will be loaded here -->
                </div>
            </section>

            <section id="requestsTab" class="waiter-tab">
                <div class="section-header">
                    <h2>Service Requests</h2>
                    <select id="requestFilter" onchange="filterRequests()">
                        <option value="all">All Requests</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                    </select>
                </div>
                <div class="requests-grid" id="waiterRequestsGrid">
                    <!-- Requests will be loaded here -->
                </div>
            </section>

            <section id="tablesTab" class="waiter-tab">
                <div class="section-header">
                    <h2>Table Status</h2>
                </div>
                <div class="tables-grid" id="tablesGrid">
                    <!-- Tables will be loaded here -->
                </div>
            </section>

            <section id="myOrdersTab" class="waiter-tab">
                <div class="section-header">
                    <h2>My Assigned Orders</h2>
                </div>
                <div class="orders-grid" id="myOrdersGrid">
                    <!-- My orders will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal" id="orderDetailModal">
        <div class="modal-content wide-modal">
            <div class="modal-header">
                <h2>Order Details - Table <span id="modalTableNumber"></span></h2>
                <button class="close-modal" onclick="closeOrderModal()">&times;</button>
            </div>
            <div id="orderLockInfo" class="waiter-badge" style="margin-bottom: 1rem; padding: 10px; background: #fff3e0;">
                <!-- Lock info will be shown here -->
            </div>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                <div class="order-items-list" id="modalOrderItems" style="max-height: 400px; overflow-y: auto;">
                    <!-- Order items -->
                </div>
                <div class="order-controls">
                    <h3>Update Status</h3>
                    <div class="form-group">
                        <select id="updateOrderStatus">
                            <option value="pending">Pending</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estimated Time (minutes)</label>
                        <input type="number" id="estimatedTime" min="1" max="120" value="15">
                    </div>
                    <div id="waiverIdSection" class="form-group">
                        <label>Enter Your 4-digit ID to Claim Order</label>
                        <input type="password" id="claimWaiterId" class="waiter-id-input" placeholder="****" maxlength="4" pattern="\d*" inputmode="numeric">
                    </div>
                    <button class="btn btn-primary" onclick="claimAndUpdateOrder()" style="width: 100%;" id="claimUpdateButton">
                        <i class="fas fa-check"></i> Claim & Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div class="modal" id="requestDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalRequestTitle">Request Details</h2>
                <button class="close-modal" onclick="closeRequestModal()">&times;</button>
            </div>
            <div class="request-info" id="modalRequestInfo">
                <!-- Request details -->
            </div>
            <div class="waiter-response-form">
                <h3>Respond to Request</h3>
                <div class="form-group">
                    <label for="waiterNameSelect">Your Name</label>
                    <select id="waiterNameSelect">
                        <!-- Staff names will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="waiterIdResponse">Your 4-digit ID</label>
                    <input type="password" id="waiterIdResponse" class="waiter-id-input" placeholder="****" maxlength="4" pattern="\d*" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="waiterResponse">Response Message (optional)</label>
                    <textarea id="waiterResponse" placeholder="Type your response message..." rows="3"></textarea>
                </div>
                <div class="request-actions" style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="acceptRequest()" style="flex: 1;">
                        <i class="fas fa-check"></i> Accept
                    </button>
                    <button class="btn" onclick="completeRequest()" style="flex: 1; background: var(--accent-color, #4CAF50); color: white;">
                        <i class="fas fa-check-double"></i> Complete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDn3dGe2dhgfrqwYENgWA1biEW8ngXv068",
            authDomain: "office-manager-pro-1b6ae.firebaseapp.com",
            projectId: "office-manager-pro-1b6ae",
            storageBucket: "office-manager-pro-1b6ae.firebasestorage.app",
            messagingSenderId: "202156442292",
            appId: "1:202156442292:web:664d17e9c8e75535168de1",
            measurementId: "G-BTY9GY3HBX"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Collections
        const ordersRef = db.collection("orders");
        const requestsRef = db.collection("requests");
        const staffRef = db.collection("staff");
        const settingsRef = db.collection("settings");

        // Global Variables
        let currentOrderId = null;
        let currentRequestId = null;
        let currentStaffList = [];
        let currentWaiter = null;
        let institutionSettings = null;
        let themeSettings = null;

        // Load institution settings
        async function loadInstitutionSettings() {
            try {
                const settingsDoc = await settingsRef.doc('institution').get();
                if (settingsDoc.exists) {
                    institutionSettings = settingsDoc.data();
                    document.getElementById('institutionName').textContent = institutionSettings.name || 'QR Order System';
                }
            } catch (error) {
                console.error('Error loading institution settings:', error);
            }
        }

        // Load theme settings
        async function loadThemeSettings() {
            try {
                const themeDoc = await settingsRef.doc('theme').get();
                if (themeDoc.exists) {
                    themeSettings = themeDoc.data();
                    applyTheme(themeSettings);
                }
            } catch (error) {
                console.error('Error loading theme settings:', error);
            }
        }

        function applyTheme(theme) {
            document.documentElement.style.setProperty('--primary-color', theme.primary || '#667eea');
            document.documentElement.style.setProperty('--secondary-color', theme.secondary || '#764ba2');
            document.documentElement.style.setProperty('--accent-color', theme.accent || '#4CAF50');
            document.documentElement.style.setProperty('--accent-hover', theme.accentHover || '#45a049');
        }

        // Waiter Functions
        async function loginAsWaiter() {
            const waiterId = document.getElementById('waiterId').value;
            
            if (!waiterId || waiterId.length !== 4) {
                showNotification('Please enter a valid 4-digit ID', 'error');
                return;
            }
            
            try {
                // Find staff with matching ID
                const staffSnapshot = await staffRef.where('waiterId', '==', waiterId).get();
                
                if (staffSnapshot.empty) {
                    showNotification('Invalid waiter ID', 'error');
                    return;
                }
                
                const staffDoc = staffSnapshot.docs[0];
                currentWaiter = {
                    id: staffDoc.id,
                    ...staffDoc.data()
                };
                
                document.getElementById('waiterLanding').style.display = 'none';
                document.getElementById('waiterPage').classList.add('active');
                document.getElementById('currentWaiterName').textContent = currentWaiter.name;
                document.getElementById('currentWaiterId').textContent = `(ID: ${currentWaiter.waiterId})`;
                
                initializeWaiterApp();
            } catch (error) {
                console.error('Error logging in:', error);
                showNotification('Login failed', 'error');
            }
        }

        function logoutWaiter() {
            currentWaiter = null;
            document.getElementById('waiterPage').classList.remove('active');
            document.getElementById('waiterLanding').style.display = 'flex';
            document.getElementById('waiterId').value = '';
        }

        function initializeWaiterApp() {
            loadWaiterOrders();
            loadWaiterRequests();
            loadTables();
            loadStaffList();
            loadMyOrders();
            loadInstitutionSettings();
            loadThemeSettings();
            setupWaiterRealtimeListeners();
        }

        async function loadWaiterOrders() {
            try {
                const ordersSnapshot = await ordersRef
                    .where('status', 'in', ['pending', 'preparing', 'ready'])
                    .orderBy('createdAt', 'desc')
                    .get();
                
                renderWaiterOrders(ordersSnapshot.docs);
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function renderWaiterOrders(orderDocs) {
            const ordersGrid = document.getElementById('waiterOrdersGrid');
            ordersGrid.innerHTML = '';
            
            orderDocs.forEach(doc => {
                const order = doc.data();
                
                // Don't show locked orders that belong to other waiters
                if (order.lockedTo && order.lockedTo !== currentWaiter?.waiterId) {
                    return;
                }
                
                const orderCard = document.createElement('div');
                orderCard.className = `waiter-order-card ${order.status} ${order.lockedTo ? 'locked' : ''}`;
                orderCard.onclick = () => openOrderDetail(doc.id, order);
                
                const itemsPreview = order.items?.slice(0, 2).map(item => 
                    `${item.name} × ${item.quantity}`
                ).join(', ');
                
                const moreItems = order.items?.length > 2 ? 
                    ` +${order.items.length - 2} more items` : '';
                
                let waiterInfo = '';
                if (order.assignedWaiter) {
                    waiterInfo = `<div class="waiter-badge"><i class="fas fa-user-check"></i> ${order.assignedWaiter}</div>`;
                }
                
                orderCard.innerHTML = `
                    <div class="order-card-header">
                        <h3>Table ${order.tableNumber}</h3>
                        <span class="order-status-badge ${order.status}">
                            ${order.status}
                        </span>
                    </div>
                    ${waiterInfo}
                    <div class="order-items-preview">
                        ${itemsPreview}${moreItems}
                    </div>
                    <div class="order-card-footer">
                        <div class="order-total">$${order.total?.toFixed(2) || '0.00'}</div>
                        <div class="order-time">
                            ${order.createdAt ? formatTimeAgo(order.createdAt.toDate()) : 'Just now'}
                        </div>
                    </div>
                `;
                ordersGrid.appendChild(orderCard);
            });
        }

        async function loadMyOrders() {
            if (!currentWaiter) return;
            
            try {
                const ordersSnapshot = await ordersRef
                    .where('lockedTo', '==', currentWaiter.waiterId)
                    .where('status', 'in', ['pending', 'preparing', 'ready'])
                    .orderBy('createdAt', 'desc')
                    .get();
                
                renderMyOrders(ordersSnapshot.docs);
            } catch (error) {
                console.error('Error loading my orders:', error);
            }
        }

        function renderMyOrders(orderDocs) {
            const ordersGrid = document.getElementById('myOrdersGrid');
            ordersGrid.innerHTML = '';
            
            if (orderDocs.length === 0) {
                ordersGrid.innerHTML = '<div style="text-align: center; padding: 3rem; color: #666;">No assigned orders</div>';
                return;
            }
            
            orderDocs.forEach(doc => {
                const order = doc.data();
                const orderCard = document.createElement('div');
                orderCard.className = `waiter-order-card ${order.status}`;
                orderCard.onclick = () => openOrderDetail(doc.id, order);
                
                const itemsPreview = order.items?.slice(0, 2).map(item => 
                    `${item.name} × ${item.quantity}`
                ).join(', ');
                
                orderCard.innerHTML = `
                    <div class="order-card-header">
                        <h3>Table ${order.tableNumber}</h3>
                        <span class="order-status-badge ${order.status}">
                            ${order.status}
                        </span>
                    </div>
                    <div class="order-items-preview">
                        ${itemsPreview}
                    </div>
                    <div class="order-card-footer">
                        <div class="order-total">$${order.total?.toFixed(2) || '0.00'}</div>
                        <div class="order-time">
                            ${order.createdAt ? formatTimeAgo(order.createdAt.toDate()) : ''}
                        </div>
                    </div>
                `;
                ordersGrid.appendChild(orderCard);
            });
        }

        async function loadWaiterRequests() {
            try {
                const requestsSnapshot = await requestsRef
                    .where('status', 'in', ['pending', 'in_progress'])
                    .orderBy('createdAt', 'desc')
                    .get();
                
                renderWaiterRequests(requestsSnapshot.docs);
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        function renderWaiterRequests(requestDocs) {
            const requestsGrid = document.getElementById('waiterRequestsGrid');
            requestsGrid.innerHTML = '';
            
            requestDocs.forEach(doc => {
                const request = doc.data();
                const requestCard = document.createElement('div');
                requestCard.className = 'waiter-request-card';
                requestCard.onclick = () => openRequestDetail(doc.id, request);
                
                const icons = {
                    waiter: 'fa-user-tie',
                    waitress: 'fa-user-female',
                    bartender: 'fa-glass-cheers',
                    security: 'fa-shield-alt',
                    medical: 'fa-ambulance',
                    pos: 'fa-receipt',
                    special: 'fa-envelope',
                    specific_staff: 'fa-microphone'
                };
                
                requestCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <i class="fas ${icons[request.serviceType] || 'fa-bell'}" style="font-size: 1.5rem; color: var(--primary-color, #2196F3);"></i>
                        <div>
                            <h3 style="margin: 0;">${getServiceTypeName(request.serviceType)}</h3>
                            <p style="margin: 5px 0 0; color: #666; font-size: 0.9rem;">
                                Table ${request.tableNumber}
                            </p>
                        </div>
                    </div>
                    ${request.message ? `<p style="color: #666; font-size: 0.95rem;">${request.message}</p>` : ''}
                    ${request.assignedTo ? `<div class="waiter-badge"><i class="fas fa-user-check"></i> ${request.assignedTo}</div>` : ''}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                        <span class="order-status-badge ${request.status}">
                            ${request.status === 'in_progress' ? 'In Progress' : 'Pending'}
                        </span>
                        <span style="font-size: 0.85rem; color: #666;">
                            ${request.createdAt ? formatTimeAgo(request.createdAt.toDate()) : 'Just now'}
                        </span>
                    </div>
                `;
                requestsGrid.appendChild(requestCard);
            });
            
            // Update notification count
            const pendingCount = requestDocs.filter(doc => 
                doc.data().status === 'pending'
            ).length;
            document.getElementById('notificationCount').textContent = pendingCount;
        }

        async function loadTables() {
            const ordersSnapshot = await ordersRef
                .where('status', 'in', ['pending', 'preparing', 'ready'])
                .get();
            
            const tablesMap = new Map();
            ordersSnapshot.docs.forEach(doc => {
                const order = doc.data();
                if (!tablesMap.has(order.tableNumber)) {
                    tablesMap.set(order.tableNumber, []);
                }
                tablesMap.get(order.tableNumber).push(order);
            });
            
            const tablesGrid = document.getElementById('tablesGrid');
            tablesGrid.innerHTML = '';
            
            if (tablesMap.size === 0) {
                tablesGrid.innerHTML = '<div style="text-align: center; padding: 3rem; color: #666;">No active tables</div>';
                return;
            }
            
            Array.from(tablesMap.entries()).forEach(([tableNumber, orders]) => {
                const activeOrders = orders.length;
                const totalAmount = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                
                const tableCard = document.createElement('div');
                tableCard.className = 'waiter-order-card';
                tableCard.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fas fa-chair" style="font-size: 3rem; color: var(--primary-color, #2196F3); margin-bottom: 1rem;"></i>
                        <h2 style="margin: 0;">Table ${tableNumber}</h2>
                        <p style="color: #666; margin-top: 0.5rem;">${activeOrders} active order(s)</p>
                        <p style="color: var(--accent-color); font-weight: bold;">$${totalAmount.toFixed(2)}</p>
                    </div>
                `;
                tablesGrid.appendChild(tableCard);
            });
        }

        async function loadStaffList() {
            try {
                const staffSnapshot = await staffRef.get();
                currentStaffList = staffSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading staff list:', error);
            }
        }

        function openOrderDetail(orderId, order) {
            currentOrderId = orderId;
            
            document.getElementById('modalTableNumber').textContent = order.tableNumber;
            document.getElementById('updateOrderStatus').value = order.status;
            document.getElementById('estimatedTime').value = order.estimatedTime || 15;
            
            // Show lock info
            const lockInfo = document.getElementById('orderLockInfo');
            if (order.lockedTo) {
                lockInfo.innerHTML = `<i class="fas fa-lock"></i> This order is locked to Waiter ID: ${order.lockedTo} (${order.assignedWaiter || 'Unknown'})`;
                document.getElementById('waiverIdSection').style.display = 'none';
                document.getElementById('claimUpdateButton').innerHTML = '<i class="fas fa-check"></i> Update Status';
            } else {
                lockInfo.innerHTML = '<i class="fas fa-unlock"></i> This order is available to claim';
                document.getElementById('waiverIdSection').style.display = 'block';
                document.getElementById('claimUpdateButton').innerHTML = '<i class="fas fa-check"></i> Claim & Update Status';
            }
            
            const orderItems = document.getElementById('modalOrderItems');
            orderItems.innerHTML = '';
            
            if (order.items) {
                order.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.style.cssText = `
                        display: flex; justify-content: space-between; align-items: center;
                        padding: 1rem; background: #f8f9fa; margin-bottom: 0.5rem; border-radius: 8px;
                    `;
                    itemElement.innerHTML = `
                        <div>
                            <h4 style="margin: 0;">${item.name}</h4>
                            ${item.specification ? `<p style="margin: 5px 0 0; color: #666;">${item.specification}</p>` : ''}
                            <p style="margin: 5px 0 0; color: #666;">$${item.price.toFixed(2)} × ${item.quantity}</p>
                        </div>
                        <div style="font-weight: bold; color: var(--primary-color, #2196F3);">
                            $${(item.price * item.quantity).toFixed(2)}
                        </div>
                    `;
                    orderItems.appendChild(itemElement);
                });
            }
            
            document.getElementById('orderDetailModal').classList.add('active');
        }

        async function claimAndUpdateOrder() {
            const newStatus = document.getElementById('updateOrderStatus').value;
            const estimatedTime = document.getElementById('estimatedTime').value;
            
            try {
                const orderDoc = await ordersRef.doc(currentOrderId).get();
                const order = orderDoc.data();
                
                // If order is not locked, verify waiter ID
                if (!order.lockedTo) {
                    const waiterId = document.getElementById('claimWaiterId').value;
                    
                    if (!waiterId || waiterId.length !== 4) {
                        showNotification('Please enter your 4-digit ID to claim this order', 'error');
                        return;
                    }
                    
                    // Verify waiter ID
                    const staffSnapshot = await staffRef.where('waiterId', '==', waiterId).get();
                    
                    if (staffSnapshot.empty) {
                        showNotification('Invalid waiter ID', 'error');
                        return;
                    }
                    
                    const staffDoc = staffSnapshot.docs[0];
                    const waiterName = staffDoc.data().name;
                    
                    // Lock order to this waiter
                    await ordersRef.doc(currentOrderId).update({
                        status: newStatus,
                        estimatedTime: parseInt(estimatedTime),
                        lockedTo: waiterId,
                        assignedWaiter: waiterName,
                        claimedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification(`Order claimed by ${waiterName}!`);
                } else {
                    // If locked, check if current waiter owns it
                    if (order.lockedTo !== currentWaiter?.waiterId) {
                        showNotification('This order is locked to another waiter', 'error');
                        return;
                    }
                    
                    await ordersRef.doc(currentOrderId).update({
                        status: newStatus,
                        estimatedTime: parseInt(estimatedTime),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('Order status updated!');
                }
                
                closeOrderModal();
                loadWaiterOrders();
                loadMyOrders();
            } catch (error) {
                console.error('Error updating order:', error);
                showNotification('Failed to update order', 'error');
            }
        }

        function openRequestDetail(requestId, request) {
            currentRequestId = requestId;
            
            document.getElementById('modalRequestTitle').textContent = 
                getServiceTypeName(request.serviceType);
            
            const requestInfo = document.getElementById('modalRequestInfo');
            requestInfo.innerHTML = `
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                    <p><strong>Table:</strong> ${request.tableNumber}</p>
                    <p><strong>Time:</strong> ${request.createdAt ? request.createdAt.toDate().toLocaleTimeString() : ''}</p>
                    <p><strong>Status:</strong> <span class="order-status-badge ${request.status}">
                        ${request.status === 'in_progress' ? 'In Progress' : 'Pending'}
                    </span></p>
                    ${request.message ? `<p><strong>Message:</strong><br>${request.message}</p>` : ''}
                    ${request.staffName ? `<p><strong>Staff:</strong> ${request.staffName}</p>` : ''}
                </div>
            `;
            
            // Populate waiter name dropdown
            const waiterSelect = document.getElementById('waiterNameSelect');
            waiterSelect.innerHTML = '';
            currentStaffList.forEach(staff => {
                if (staff.role === 'waiter' || staff.role === 'waitress') {
                    const option = document.createElement('option');
                    option.value = staff.name;
                    option.textContent = staff.name;
                    waiterSelect.appendChild(option);
                }
            });
            
            document.getElementById('requestDetailModal').classList.add('active');
        }

        async function acceptRequest() {
            const waiterName = document.getElementById('waiterNameSelect').value;
            const waiterId = document.getElementById('waiterIdResponse').value;
            const response = document.getElementById('waiterResponse').value;
            
            if (!waiterName) {
                showNotification('Please select your name', 'error');
                return;
            }
            
            if (!waiterId || waiterId.length !== 4) {
                showNotification('Please enter your 4-digit ID', 'error');
                return;
            }
            
            // Verify waiter ID
            const staffSnapshot = await staffRef.where('waiterId', '==', waiterId).get();
            
            if (staffSnapshot.empty) {
                showNotification('Invalid waiter ID', 'error');
                return;
            }
            
            try {
                await requestsRef.doc(currentRequestId).update({
                    status: 'in_progress',
                    assignedTo: waiterName,
                    assignedId: waiterId,
                    waiterResponse: response || 'Waiter is on the way',
                    assignedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Request accepted!');
                closeRequestModal();
            } catch (error) {
                console.error('Error accepting request:', error);
                showNotification('Failed to accept request', 'error');
            }
        }

        async function completeRequest() {
            try {
                await requestsRef.doc(currentRequestId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Request completed!');
                closeRequestModal();
            } catch (error) {
                console.error('Error completing request:', error);
                showNotification('Failed to complete request', 'error');
            }
        }

        function closeOrderModal() {
            document.getElementById('orderDetailModal').classList.remove('active');
            document.getElementById('claimWaiterId').value = '';
        }

        function closeRequestModal() {
            document.getElementById('requestDetailModal').classList.remove('active');
            document.getElementById('waiterNameSelect').value = '';
            document.getElementById('waiterIdResponse').value = '';
            document.getElementById('waiterResponse').value = '';
        }

        function showWaiterTab(tabId) {
            document.querySelectorAll('.waiter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabId}Tab`).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load tab-specific data
            if (tabId === 'myOrders') {
                loadMyOrders();
            }
        }

        function setupWaiterRealtimeListeners() {
            ordersRef
                .where('status', 'in', ['pending', 'preparing', 'ready'])
                .onSnapshot(snapshot => {
                    loadWaiterOrders();
                    loadMyOrders();
                    loadTables();
                });
            
            requestsRef
                .where('status', 'in', ['pending', 'in_progress'])
                .onSnapshot(snapshot => {
                    renderWaiterRequests(snapshot.docs);
                });
        }

        function getServiceTypeName(serviceType) {
            const names = {
                waiter: 'Waiter Request',
                waitress: 'Waitress Request',
                bartender: 'Bartender Request',
                security: 'Security Request',
                medical: 'Medical Emergency',
                pos: 'POS/Receipt Request',
                special: 'Special Request',
                specific_staff: 'Staff Call'
            };
            return names[serviceType] || serviceType;
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hr ago`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays} days ago`;
        }

        function showNotificationPanel() {
            showNotification('Notification panel coming soon!');
        }

        function filterOrders() {
            showNotification('Filtering orders...');
        }

        function filterRequests() {
            showNotification('Filtering requests...');
        }

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load institution and theme settings
            loadInstitutionSettings();
            loadThemeSettings();
            
            // Add CSS for notifications
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        });
    </script>
</body>
</html>
